# Solo 功能：延音设计文档

本文档记录了为 Solo 编辑和播放功能增加延音 (Sustain) 支持的最终设计方案。

核心思想是：用户通过在UI上使用“延音”工具来间接编辑音符的 `duration`（时长）属性，播放器则严格根据每个音符的 `duration` 属性来控制发声和停止。

---

### 1. 数据模型 (`DataModels.swift`)

为了兼容旧数据，同时支持新功能，`SoloNote` 结构体中的 `duration` 属性被定义为可选的 `Double?`。

- **文件**: `ChordPlayer/Models/DataModels.swift`
- **结构体**: `SoloNote`

```swift
struct SoloNote: Codable, Identifiable, Hashable, Equatable {
    var id = UUID()
    var startTime: Double
    var duration: Double?       // 设为可选类型，以兼容没有时长的旧数据
    var string: Int
    var fret: Int
    // ... 其他属性保持不变
}
```

---

### 2. 数据迁移 (加载时)

为了无缝处理没有 `duration` 属性的旧数据，在加载 `Preset` 后，需要立即执行一个数据迁移步骤。

- **时机**: 从文件加载 `Preset` 数据之后，在内存中执行。
- **逻辑**:
  1. 遍历 `Preset` 中的每一个 `SoloSegment`。
  2. 在 `SoloSegment` 中，遍历每一个 `SoloNote`。
  3. 如果 `note.duration` 为 `nil`，则触发旧逻辑计算：
     a. 找到该 `note` 所在弦上的下一个音符 `nextNoteOnSameString`。
     b. 如果找到了，则 `duration = nextNoteOnSameString.startTime - note.startTime`。
     c. 如果没找到（即为该弦上最后一个音符），则 `duration = segment.lengthInBeats - note.startTime`。
  4. 将计算出的 `duration` 赋值给 `note.duration`。
- **效果**: 此步骤完成后，应用程序的其余部分（播放器、编辑器）可以安全地认为 `duration` 总是存在值，从而简化逻辑。当用户保存时，已计算的 `duration` 会被持久化。

---

### 3. UI 与交互逻辑 (`SoloEditorView.swift`)

UI是本次功能实现的核心。用户通过选择不同的“工具”来与编辑器交互，从而改变音符的时长。

#### a. 工具栏 (`SoloToolbar`)

- 在工具栏中增加一个 `Picker`，提供两种编辑工具：
  - **音符 (Note)**: 用于添加/编辑音符。
  - **延音 (Sustain)**: 用于调整音符的时长。

#### b. 编辑交互

用户的点击操作会根据当前选择的工具有不同的行为。

- **使用“音符”工具**:
  - 点击网格 `(string, time)`，如果该位置没有音符，则创建一个新的 `SoloNote` 对象；如果已有音符，则会选中它。

- **使用“延音”工具 (`-`)**:
  - 在网格 `(string, time)` 位置点击，会触发以下后台计算：
    1. 找到这根弦上，`time` 位置之前的最后一个 `SoloNote`。
    2. 计算并**更新**该音符的 `duration` 属性，使其结束时间点与用户点击的 `time` 位置对齐。
    3. 这意味着，点击音符后面的位置会**延长**音符，点击音符当前时长内的某个位置会**缩短**音符（产生休止效果）。
  - UI上，会在音符和其结束点之间显示一个延音符号 `-`。

- **删除符号** (即调整时长):
  - 在“延音”模式下，再次点击其他时间格，会重新计算前一个音符的 `duration`，使其与新的点击位置对齐。

---

### 4. 播放逻辑 (`SoloPlayer.swift`)

播放逻辑将简化，变得更加精确和健壮，严格遵循数据模型。

- **文件**: `ChordPlayer/Players/SoloPlayer.swift`

#### a. 读取时长

- 在 `play` 方法中，为每个准备播放的 `note` 读取其时长。由于数据迁移步骤的存在，可以认为 `note.duration` 总是有值。为保险起见，仍可提供默认值。
  ```swift
  let noteDuration = note.duration ?? 1.0
  ```

#### b. 精确调度

- **Note On**: 音符的发声事件 (Note On) 在 `note.startTime` 指定的时间点进行调度。
- **Note Off**: 音符的停止事件 (Note Off) 在 `note.startTime + noteDuration` 指定的时间点进行调度。
- **逻辑移除**: 原有的“遇到同弦下一个音符时停止当前音符”的复杂推断逻辑将被**彻底移除**。播放行为完全由每个音符自身的 `duration` 属性决定，实现了数据和表现的严格统一。
