# 歌词编辑器功能迭代与设计文档

本文档记录了近期对歌词片段编辑器（Melodic Lyric Editor）所做的一系列重要功能迭代和UI/UX改进，旨在为后续的维护和开发提供参考。

## 1. 核心功能：支持音符自定义时长（Duration）

这是本次系列更新的核心。为了让音符不再局限于固定的网格长度，我们引入了时长的概念。

### 1.1. 数据模型变更 (`DataModels.swift`)

- **`MelodicLyricItem`**: 新增 `duration: Int?` 属性。
  - 该属性表示音符的持续时间，单位为最小的16分音符。
  - 设为可选类型 (`Int?`) 是为了**向后兼容**，确保旧版本创建的、不含 `duration` 的配置文件依然能被正常解析。
- **`MelodicLyricSegment`**: 新增 `gridUnit: Int?` 属性。
  - 该属性用于存储当前编辑器的网格设置（如1代表16分音符，2代表8分音符等）。
  - 这使得每个歌词片段可以“记住”自己独立的网格偏好。

### 1.2. 播放引擎适配 (`MelodicLyricPlayer.swift`)

- **问题**: 最初的播放引擎忽略了 `duration`，音符的结束时间由下一个音符的开始时间决定。
- **修复**: 重构了 `schedulePlayback` 方法。现在，所有音符（包括普通音符和带技巧的音符）的 `Note Off` 事件都严格根据其自身的 `duration` 属性来调度。对于缺少 `duration` 的旧数据，则沿用旧逻辑作为兼容性 fallback。

## 2. UI/UX 改进：时长的可视化与交互

为了让 `duration` 属性在UI上获得直观、专业且美观的体现，我们对音符单元格 (`MelodicLyricCellView`) 进行了重新设计。

### 2.1. "DAW风格" 的视觉设计

- **设计理念**: 摒弃了简单的色块高亮，采用了类似专业数字音频工作站（DAW）的钢琴卷帘窗风格。
- **视觉元素**:
  - **轮廓与半透明填充**: 音符单元格的长度由 `duration` 决定，它拥有一个清晰的轮廓和半透明的背景填充。这既明确标示了音符范围，又避免了大色块带来的视觉疲劳。
  - **交互高亮**: 选中的音符会通过提升背景不透明度和增加阴影来获得“浮起”的视觉反馈。
  - **内容左对齐**: 音符的文本信息（音高、歌词）始终位于单元格的最左侧，作为音符的“头”。
  - **字体大小**: 字体大小与基础网格单位宽度挂钩，而非音符总长度，避免了音符变长时文字也跟着变得过大的问题。

### 2.2. 核心交互：延音与缩短

为了灵活地编辑 `duration`，我们设计了全新的交互逻辑。

- **延音 (`-` 键)**: 在任意单元格上按 `-` 键，会自动寻找并延长前一个音符的 `duration`，使其正好持续到当前选中单元格的起始位置。此操作会自动“吞噬”掉被覆盖的音符。
- **缩短音符 (解决长音符遮挡问题)**:
  - **问题**: 一个长音符会遮挡其下方的单元格，导致无法选中它们以进行缩短操作。
  - **解决方案**: 重构了单元格的点击手势。现在，**单击**长音符的任意位置，可以精确选中其覆盖范围下的具体网格单元。选中后，即可再次使用 `-` 键或创建新音符来间接实现“缩短”前一个音符的效果。
  - **双击**: 为了保留便捷性，**双击**音符的任意位置，依然会选中该音符的起始点并立即进入文字编辑模式。

## 3. Bug 修复

在本次迭代中，我们还修复了一些早期问题：

- **方向键移动选择框，UI状态不同步**: 修复了使用键盘方向键移动高亮框时，顶部的技巧选择栏等UI状态不会随之更新的问题。通过统一调用 `selectStep` 函数来集中管理状态更新，确保了数据和UI的一致性。
