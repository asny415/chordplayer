# 自动保存功能说明

## 功能概述

guitarPlayer 现在支持完全自动的数据持久化功能，用户对全局配置、组配置的任何修改都会自动保存到本地存储，无需用户手动操作。

## 主要特性

### ✅ 无感知自动保存
- **实时保存**：任何配置修改都会在2秒内自动保存
- **防抖机制**：避免频繁保存，提高性能
- **用户无感知**：无需手动保存，完全自动化

### ✅ 应用生命周期保护
- **应用失去焦点时**：自动保存当前状态
- **应用退出时**：确保数据完整保存
- **系统关闭时**：在系统关闭前保存数据
- **异常退出保护**：即使应用崩溃也能保存数据

### ✅ 启动时自动恢复
- **智能加载**：启动时自动加载上次保存的配置
- **默认值回退**：如果保存文件损坏，自动使用默认配置
- **无缝体验**：用户重启应用后立即恢复到上次的状态

## 保存的数据

### 性能配置 (PerformanceConfig)
- 节拍 (Tempo)
- 拍号 (Time Signature)
- 调性 (Key)
- 量化模式 (Quantization Mode)
- 鼓点模式 (Drum Pattern)
- 键盘映射 (Key Map)
- 所有组配置 (Pattern Groups)

### 应用配置 (AppConfig)
- MIDI端口名称
- 音符设置
- 力度设置
- 持续时间设置
- 通道设置

## 文件存储位置

数据保存在用户的Documents目录中：
- `~/Documents/performance_config.json` - 性能配置
- `~/Documents/app_config.json` - 应用配置

## 调试功能

### 自动保存调试面板
点击控制栏右侧的 💾 图标可以打开自动保存调试面板，查看：

- **保存文件状态**：显示哪些文件已保存，文件大小和修改时间
- **当前配置信息**：显示当前的组数量、节拍、调性等
- **手动操作**：
  - 手动保存：立即保存所有数据
  - 重置到默认值：清除保存的数据并重置为默认配置
  - 刷新状态：更新显示信息

### 控制台日志
应用会在控制台输出详细的保存和加载日志：
```
[DataPersistenceManager] ✅ Performance config saved successfully
[AppData] ✅ Loaded saved performance config
[AppData] App will resign active - saving data...
```

## 技术实现

### 核心组件

1. **DataPersistenceManager** - 数据持久化管理器
   - 负责文件的保存和加载
   - 实现防抖机制
   - 处理文件操作错误

2. **AppData** - 应用数据模型
   - 集成自动保存逻辑
   - 监听数据变化
   - 处理应用生命周期事件

3. **AutoSaveDebugView** - 调试界面
   - 提供可视化的保存状态
   - 支持手动操作
   - 显示详细信息

### 保存机制

1. **实时保存**：使用 `@Published` 属性的 `didSet` 监听数据变化
2. **防抖保存**：使用 `Timer` 实现2秒延迟保存，避免频繁IO操作
3. **生命周期保存**：监听 `NSApplication` 和 `NSWorkspace` 通知
4. **JSON序列化**：使用 `Codable` 协议进行数据序列化

## 使用建议

1. **正常使用**：无需任何额外操作，所有配置会自动保存
2. **调试问题**：使用调试面板查看保存状态
3. **重置配置**：如果遇到问题，可以使用"重置到默认值"功能
4. **备份数据**：重要配置建议定期备份Documents目录中的JSON文件

## 故障排除

### 如果配置没有保存
1. 检查控制台日志是否有错误信息
2. 确认Documents目录有写入权限
3. 使用调试面板查看保存状态

### 如果配置没有加载
1. 检查JSON文件是否存在且格式正确
2. 查看控制台日志中的加载错误
3. 尝试重置到默认值

### 如果应用崩溃
- 应用会在崩溃前尝试保存数据
- 重启后应该能恢复到崩溃前的状态
- 如果仍有问题，使用调试面板重置配置

## 版本兼容性

- 自动保存功能向后兼容
- 旧版本的数据会自动迁移
- 新字段会使用默认值填充

---

*自动保存功能让您专注于音乐创作，无需担心数据丢失！* 🎵
